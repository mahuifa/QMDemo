# FFmpegå¤šåª’ä½“æ¡†æ¶å¼€å‘Demo

[toc]

---

## 1ã€è¯´æ˜

|     ç±»å      | åŠŸèƒ½                                                         |
| :-----------: | ------------------------------------------------------------ |
|   VideoPlay   | ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼›               |
| VideoPlayGL1  | ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç  + OpenGLæ˜¾ç¤ºRGBå›¾åƒã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼› |
| VideoPlayGL2  | ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç  + OpenGLæ˜¾ç¤ºYUVå›¾åƒã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼› |
|  VideoPlayHW  | ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€ç¡¬è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼›               |
| VideoPlayHWGL | ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯/ç¡¬è§£ç  + OpenGLæ˜¾ç¤ºYUV/NV12ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼› |
| VideoCamera1  | FFmpegæ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ç®€å•ç¤ºä¾‹ï¼ˆè½¯è§£ç +OpenGLï¼‰ï¼›              |
| VideoCamera2  | ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘æ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ã€å½•åˆ¶è§†é¢‘ã€‘ä¿å­˜åˆ°æœ¬åœ°ç¤ºä¾‹ï¼› |
|  AVIOReading  | APIç¤ºä¾‹ç¨‹åºï¼Œæ¼”ç¤ºå¦‚ä½•ä»é€šè¿‡AVIOContextè®¿é—®çš„è‡ªå®šä¹‰ç¼“å†²åŒºè¯»å–æ•°æ®ï¼› |
|  DecodeAudio  | ä½¿ç”¨libavcodec APIçš„éŸ³é¢‘è§£ç ç¤ºä¾‹ï¼ˆMP3è½¬pcmï¼‰ï¼›               |
|   Screencap   | FFmpegå®ç°å½•å±åŠŸèƒ½                                           |
| VideoPlaySave | ä½¿ç”¨è½¯è§£ç å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼Œå¹¶å°†H264è£¸æµä¿å­˜åˆ°è§†é¢‘æ–‡ä»¶ä¸­ï¼ˆæ— éœ€ç¼–ç ï¼‰ |

 


## 2ã€ç›¸å…³åšå®¢

|                           ç›¸å…³åšå®¢                           |
| :----------------------------------------------------------: |
| ğŸ‘‰[CSDN](https://blog.csdn.net/qq_43627907/category_11660518.html)ğŸ‘ˆ |




## 3ã€å®ç°æ•ˆæœ

### 1.1 VideoPlay

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼›
> 2. æ”¯æŒæ‰“å¼€æœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼ˆå¦‚mp4ã€movã€aviç­‰ï¼‰ã€ç½‘ç»œè§†é¢‘æµï¼ˆrtspã€rtmpã€httpç­‰ï¼‰ï¼›
> 3. æ”¯æŒè§†é¢‘ã€åŒ€é€Ÿæ’­æ”¾ã€‘ï¼›
> 4. é‡‡ç”¨QPainterè¿›è¡Œæ˜¾ç¤ºï¼Œæ”¯æŒã€è‡ªé€‚åº”ã€‘çª—å£ç¼©æ”¾ï¼›
> 5. è§†é¢‘æ’­æ”¾æ”¯æŒå®æ—¶ã€å¼€å§‹/å…³é—­ã€æš‚åœ/ç»§ç»­ã€‘æ’­æ”¾ï¼›
> 6. è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œã€ä½è€¦åˆåº¦ã€‘ã€‚
> 7. é‡‡ç”¨æœ€æ–°çš„ã€5.1.2ç‰ˆæœ¬ã€‘ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œã€è¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ã€‘ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šã€‚

* è¿™é‡Œä¸Šä¼ çš„gifå›¾ç‰‡ç»è¿‡å‹ç¼©ï¼Œæ•ˆæœè¾ƒå·®ï¼Œå®é™…ä¸ºé«˜æ¸…

![VideoPlay-tuya](FFmpegDemo.assets/VideoPlay-tuya.gif)



### 1.2 VideoPlayGL1

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼›                                    
> 2.  æ”¯æŒæ‰“å¼€æœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼ˆå¦‚mp4ã€movã€aviç­‰ï¼‰ã€ç½‘ç»œè§†é¢‘æµï¼ˆrtspã€rtmpã€httpç­‰ï¼‰ï¼›           
> 3.   æ”¯æŒè§†é¢‘åŒ€é€Ÿæ’­æ”¾ï¼›                                                   
> 4.   é‡‡ç”¨ã€OpenGLæ˜¾ç¤ºRGBã€‘å›¾åƒï¼Œæ”¯æŒè‡ªé€‚åº”çª—å£ç¼©æ”¾ï¼Œæ”¯æŒä½¿ç”¨QOpenGLWidgetã€QOpenGLWindowæ˜¾ç¤ºï¼›
> 5.   è§†é¢‘æ’­æ”¾æ”¯æŒå®æ—¶å¼€å§‹/å…³é—­ã€æš‚åœ/ç»§ç»­æ’­æ”¾ï¼›                                      
> 6.   è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œä½è€¦åˆåº¦ã€‚                                   
> 7.   é‡‡ç”¨æœ€æ–°çš„5.1.2ç‰ˆæœ¬ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œè¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šã€‚    
> 

* ä¸‹å›¾ä¸­ä½¿ç”¨OpenGLæ˜¾ç¤ºRGBå›¾åƒCPUå ç”¨ç‡æ˜¯ä½¿ç”¨QPainteræ˜¾ç¤ºçš„<mark>ä¸€åŠ</mark>ï¼Œç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯éå¸¸è€çš„ç¬”è®°æœ¬çš„é›†æ˜¾æµ‹è¯•ï¼Œæ‰€ä»¥GPUå ç”¨ç‡æ¯”è¾ƒé«˜ã€‚

![image-20221015204308041](FFmpegDemo.assets/image-20221015204308041.png)



### 1.3 VideoPlayGL2

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼›                                
> 2. æ”¯æŒæ‰“å¼€æœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼ˆå¦‚mp4ã€movã€aviç­‰ï¼‰ã€ç½‘ç»œè§†é¢‘æµï¼ˆrtspã€rtmpã€httpç­‰ï¼‰ï¼›       
> 3. æ”¯æŒè§†é¢‘åŒ€é€Ÿæ’­æ”¾ï¼›                                               
> 4. é‡‡ç”¨ã€OpenGLæ˜¾ç¤ºYUVã€‘å›¾åƒï¼Œæ”¯æŒè‡ªé€‚åº”çª—å£ç¼©æ”¾ï¼Œæ”¯æŒä½¿ç”¨QOpenGLWidgetã€QOpenGLWindowæ˜¾ç¤ºï¼›
> 5. å°†YUVè½¬RGBçš„æ­¥éª¤ç”±CPUè½¬æ¢æ”¹ä¸ºä½¿ç”¨GPUè½¬æ¢ï¼Œé™ä½CPUå ç”¨ç‡ï¼›
> 6. è§†é¢‘æ’­æ”¾æ”¯æŒå®æ—¶å¼€å§‹/å…³é—­ã€æš‚åœ/ç»§ç»­æ’­æ”¾ï¼›                                  
> 7. è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œä½è€¦åˆåº¦ã€‚                               
> 8. é‡‡ç”¨æœ€æ–°çš„5.1.2ç‰ˆæœ¬ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œè¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šã€‚
> 

* ä¸‹å›¾ä¸­ä½¿ç”¨OpenGLæ˜¾ç¤ºYUVå›¾åƒCPUå ç”¨ç‡æ˜¯ä½¿ç”¨QPainteræ˜¾ç¤ºçš„<mark>1/3å·¦å³</mark>ï¼Œç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯éå¸¸è€çš„ç¬”è®°æœ¬çš„é›†æ˜¾æµ‹è¯•ï¼Œæ‰€ä»¥GPUå ç”¨ç‡æ¯”è¾ƒé«˜ã€‚

![image-20221017232820037](FFmpegDemo.assets/image-20221017232820037.png)



### 1.4 VideoPlayHW

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€ç¡¬è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼Œé‡‡ç”¨GPUè§£ç ï¼Œ å¤§å¹…é™ä½å¯¹CPUçš„æš‚ç”¨ç‡ï¼›
> 2. æ”¯æŒæ‰“å¼€æœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼ˆå¦‚mp4ã€movã€aviç­‰ï¼‰ã€ç½‘ç»œè§†é¢‘æµï¼ˆrtspã€rtmpã€httpç­‰ï¼‰ï¼›
> 3. æ”¯æŒè§†é¢‘åŒ€é€Ÿæ’­æ”¾ï¼›
> 4. é‡‡ç”¨QPainterè¿›è¡Œæ˜¾ç¤ºï¼Œæ”¯æŒè‡ªé€‚åº”çª—å£ç¼©æ”¾ï¼›
> 5. è§†é¢‘æ’­æ”¾æ”¯æŒå®æ—¶å¼€å§‹/å…³é—­ã€æš‚åœ/ç»§ç»­æ’­æ”¾ï¼›
> 6. è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œä½è€¦åˆåº¦ã€‚
> 7. é‡‡ç”¨æœ€æ–°çš„5.1.2ç‰ˆæœ¬ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œè¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šï¼›
> 8. å±•ç¤ºäº†9è·¯è§†é¢‘æ’­æ”¾ã€‚

* ç”±äºæµ‹è¯•çš„ç”µè„‘ç¡¬ä»¶æ€§èƒ½è¿‡ä½ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ•ˆæœä¸æ˜¯å¾ˆæ˜æ˜¾

![VideoPlayHW-tuya](FFmpegDemo.assets/VideoPlayHW-tuya.png)



### 1.5 VideoPlayHWGL

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯/ç¡¬è§£ç ã€‘å®ç°çš„è§†é¢‘æ’­æ”¾å™¨ï¼›                                           
> 2. æ”¯æŒæ‰“å¼€æœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼ˆå¦‚mp4ã€movã€aviç­‰ï¼‰ã€ç½‘ç»œè§†é¢‘æµï¼ˆrtspã€rtmpã€httpç­‰ï¼‰ï¼›                    
> 3. æ”¯æŒè§†é¢‘åŒ€é€Ÿæ’­æ”¾ï¼›                                                            
> 4. é‡‡ç”¨ã€OpenGLæ˜¾ç¤ºYUVã€NV12ã€‘å›¾åƒï¼Œæ”¯æŒè‡ªé€‚åº”çª—å£ç¼©æ”¾ï¼Œæ”¯æŒä½¿ç”¨QOpenGLWidgetã€QOpenGLWindowæ˜¾ç¤ºï¼›  
> 5. å°†YUV/NV12è½¬RGBçš„æ­¥éª¤ç”±CPUè½¬æ¢æ”¹ä¸ºä½¿ç”¨GPUè½¬æ¢ï¼Œé™ä½CPUå ç”¨ç‡ï¼›                            
> 6. ä½¿ç”¨<mark>av_hwframe_map</mark>æ›¿ä»£<mark>av_hwframe_transfer_data</mark>ï¼Œå¯å°†ã€è€—æ—¶é™ä½1/3ã€‘ï¼›              
> 7. è§†é¢‘æ’­æ”¾æ”¯æŒå®æ—¶å¼€å§‹/å…³é—­ã€æš‚åœ/ç»§ç»­æ’­æ”¾ï¼›                                               
> 8. è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œä½è€¦åˆåº¦ã€‚                                            
> 9. é‡‡ç”¨æœ€æ–°çš„ã€5.1.2ç‰ˆæœ¬ã€‘ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œè¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šã€‚           

* ä½¿ç”¨GPUè§£ç  + OpenGLç»˜åˆ¶å¤§å¤§é™ä½äº†CPUå ç”¨ç‡

![image-20221020192642223](FFmpegDemo.assets/image-20221020192642223.png)



### 1.6 AVIOReading

> 1. å°†ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ä¸­è¯´æœ‰æ•°æ®è¯»å–åˆ°bufä¸­ï¼›
> 2. ä¸ºAVIOContextåˆ›å»ºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼›
> 3. åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º4096å†…å­˜avio_bufç”¨äºä»bufä¸­è¯»å–æ•°æ®ï¼›
> 4. ä½¿ç”¨å›è°ƒå‡½æ•°å®Œæˆæ•°æ®çš„è¯»å–ã€‚

* æ•°æ®è¯»å–ç¤ºä¾‹å¦‚ä¸‹

![AVIOReading-tuya](FFmpegDemo.assets/AVIOReading-tuya.gif)

![image-20221024094954935](FFmpegDemo.assets/image-20221024094954935.png)



### 1.7 DecodeAudio

> 1. ä½¿ç”¨FFmpegå°†mp3éŸ³é¢‘æ–‡ä»¶è§£ç ï¼Œå¹¶ä¿å­˜ä¸ºåŸå§‹éŸ³é¢‘æ–‡ä»¶pcmï¼›
> 2. ä½¿ç”¨Qtçš„æ–¹å¼é‡å†™äº†Demoï¼›
> 3. è§£å†³äº†å®˜æ–¹Demoä¸­çš„éƒ¨åˆ†Bugã€‚

![DecodeAudio](FFmpegDemo.assets/DecodeAudio.gif)



### 1.8 VideoCamera1

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘æ‰“å¼€ã€æœ¬åœ°æ‘„åƒå¤´ã€‘ï¼›                                       
> 2. é‡‡ç”¨ã€OpenGLæ˜¾ç¤ºYUVã€‘å›¾åƒï¼Œæ”¯æŒè‡ªé€‚åº”çª—å£ç¼©æ”¾ï¼Œæ”¯æŒä½¿ç”¨QOpenGLWidgetã€QOpenGLWindowæ˜¾ç¤ºï¼›
> 3. å°†YUVè½¬RGBçš„æ­¥éª¤ç”±CPUè½¬æ¢æ”¹ä¸ºä½¿ç”¨GPUè½¬æ¢ï¼Œé™ä½CPUå ç”¨ç‡ï¼›                          
> 4. æ”¯æŒWindowsã€Linuxæ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ï¼›                                        
> 5. è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œä½è€¦åˆåº¦ã€‚                                     
> 6. é‡‡ç”¨æœ€æ–°çš„5.1.2ç‰ˆæœ¬ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œè¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šã€‚      

![VideoCamera1](FFmpegDemo.assets/VideoCamera1.gif)

![image-20221027235118681](FFmpegDemo.assets/image-20221027235118681.png)



### 1.9 VideoCamera2

> 1. ä½¿ç”¨ffmpegéŸ³è§†é¢‘åº“ã€è½¯è§£ç ã€‘æ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ã€å½•åˆ¶è§†é¢‘ã€‘ä¿å­˜åˆ°æœ¬åœ°ï¼›                             
> 2. é‡‡ç”¨ã€OpenGLæ˜¾ç¤ºYUVã€‘å›¾åƒï¼Œæ”¯æŒè‡ªé€‚åº”çª—å£ç¼©æ”¾ï¼Œæ”¯æŒä½¿ç”¨QOpenGLWidgetã€QOpenGLWindowæ˜¾ç¤ºï¼› 
> 3. å°†YUVè½¬RGBçš„æ­¥éª¤ç”±CPUè½¬æ¢æ”¹ä¸ºä½¿ç”¨GPUè½¬æ¢ï¼Œé™ä½CPUå ç”¨ç‡ï¼›                           
> 4. æ”¯æŒWindowsã€Linuxæ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ï¼›                                        
> 5. æ”¯æŒä½¿ç”¨ã€é™æ€å¸§ç‡ã€‘ã€ã€åŠ¨æ€å¸§ç‡ã€‘å½•åˆ¶è§†é¢‘ï¼›                                         
> 6. è§†é¢‘è§£ç ã€çº¿ç¨‹æ§åˆ¶ã€æ˜¾ç¤ºå„éƒ¨åˆ†åŠŸèƒ½åˆ†ç¦»ï¼Œä½è€¦åˆåº¦ã€‚                                      
> 7. é‡‡ç”¨æœ€æ–°çš„5.1.2ç‰ˆæœ¬ffmpegåº“è¿›è¡Œå¼€å‘ï¼Œè¶…è¯¦ç»†æ³¨é‡Šä¿¡æ¯ï¼Œå°†æ‰€æœ‰è¸©è¿‡çš„å‘ã€è§£å†³åŠæ³•ã€æ³¨æ„äº‹é¡¹éƒ½å¾—å¾ˆå†™æ¸…æ¥šã€‚       

![VideoCamera2-tuya](FFmpegDemo.assets/VideoCamera2-tuya.gif)



### 1.10 Screencap

> 1. æŠ“å–æ¡Œé¢å›¾åƒè½¬ç åä¿å­˜åˆ°æœ¬åœ°è§†é¢‘æ–‡ä»¶ä¸­ï¼›           
> 2. æ”¯æŒå„ç§å¸¸è§è§†é¢‘æ–‡ä»¶ç±»å‹ï¼›                  
> 3. æ”¯æŒWindowsã€Linuxå½•å±åŠŸèƒ½ï¼›           
> 4. ä¸»è¦åŠŸèƒ½åˆ†ä¸ºå½•å±çº¿ç¨‹ã€å½•å±è§£ç ã€å›¾åƒåƒç´ è½¬æ¢ã€ç¼–ç ä¿å­˜4éƒ¨åˆ†ã€‚

![image-20230101133211140](FFmpegDemo.assets/image-20230101133211140.png)



### 1.11 VideoPlaySave

> 1. è§†é¢‘æ’­æ”¾åŠŸèƒ½ä¸ã€VideoPlayã€‘ç›¸åŒï¼›
> 2. åœ¨ä½¿ç”¨ffmpegæ‰“å¼€ç½‘ç»œè§†é¢‘æµæ—¶ï¼Œå¦‚æœæ˜¯h264è£¸æµå¯ä»¥ç›´æ¥ä¿å­˜ä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œä¸éœ€è¦è¿›è¡Œç¼–ç æ“ä½œï¼›
> 3. ç”±äºä¸éœ€è¦è¿›è¡Œç¼–ç ï¼Œå¯ä»¥å¤§å¤§é™ä½CPUå ç”¨ç‡ã€‚

![image-20230104155424623](FFmpegDemo.assets/image-20230104155424623.png)
